{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block page_title %}
{{ plugin_title }}
{% endblock page_title %}

{% block breadcrumbs %}
{% endblock breadcrumbs %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h3 class="card-title mb-4">{{ plugin_title }}</h3>

          <form class="d-none">{% csrf_token %}</form>

          <div id="bp-alert" class="alert d-none" role="alert"></div>

          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width: 40px;" class="text-center">
                    <input type="checkbox" class="form-check-input" id="bp-select-all" />
                  </th>
                  <th style="min-width: 220px;">Kategorie *</th>
                  <th style="min-width: 220px;">Name *</th>
                  <th style="min-width: 260px;">Beschreibung</th>
                  <th style="min-width: 180px;">IPN</th>
                  <th style="width: 140px;">Anzahl</th>
                  <th style="min-width: 260px;">Lagerort</th>
                  <th style="width: 90px;" class="text-end">Aktion</th>
                </tr>
              </thead>
              <tbody id="bp-rows"></tbody>
            </table>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="button" class="btn btn-primary" id="bp-add-row">
              <i class="fas fa-plus"></i> Hinzufügen
            </button>
            <button type="button" class="btn btn-outline-secondary" id="bp-reset">
              <i class="fas fa-redo"></i> Zurücksetzen
            </button>
          </div>

          <hr class="my-4" />

          <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-success btn-lg" id="bp-submit">
              <i class="fas fa-check"></i> Teile Erstellen / Einbuchen
            </button>
          </div>

          <h5 class="mb-3">Ergebnis</h5>
          <div id="bp-result" class="small text-muted mb-3">Noch keine Aktion ausgeführt.</div>

          <div class="mt-3">
            <button type="button" class="btn btn-outline-primary" id="bp-print" disabled>
              <i class="fas fa-print"></i> Labels drucken
            </button>
            <div class="form-text mt-2">
              Wählen Sie die erstellten Produkte per Checkbox aus und klicken Sie auf "Labels drucken", um den InvenTree Label-Dialog zu öffnen.
            </div>
          </div>
        </div>
      </div>

      <div class="text-center small text-muted my-4">
        © 2025 GrischaMedia.ch - <a href="https://github.com/GrischaMedia/ch.grischamedia.inventree.bulkproducts" target="_blank">GitHub Repository</a>
      </div>
    </div>
  </div>
</div>

<style>
.bp-location-wrapper {
  position: relative;
  width: 100%;
}

.bp-location-input {
  width: 100%;
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
  line-height: 1.5;
  color: #212529;
  background-color: #fff;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.bp-location-input:focus {
  color: #212529;
  background-color: #fff;
  border-color: #86b7fe;
  outline: 0;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.bp-location-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ced4da;
  border-top: none;
  border-radius: 0 0 0.25rem 0.25rem;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.bp-location-dropdown.show {
  display: block;
}

.bp-location-item {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  border-bottom: 1px solid #f8f9fa;
}

.bp-location-item:last-child {
  border-bottom: none;
}

.bp-location-item:hover {
  background-color: #f8f9fa;
}

.bp-location-item.selected {
  background-color: #0d6efd;
  color: white;
}

.table td {
  vertical-align: middle;
  padding: 0.5rem;
}

.table th {
  padding: 0.75rem 0.5rem;
}

.bp-remove {
  margin: 0;
  padding: 0.25rem 0.5rem;
}
</style>

<script>
  const BP = (() => {
    const categories = [
      {% for c in categories %}
        { id: {{ c.id }}, label: "{{ c.pathstring|default:c.name|escapejs }}" },
      {% endfor %}
    ];

    const defaultLocationId = {{ default_location_id|default:0 }};
    const apiUrl = "{% url 'plugin:bulk-products:api-bulk-create' %}";
    const searchLocationsUrl = "{% url 'plugin:bulk-products:api-search-locations' %}";
    let createdParts = [];
    let locationSearchTimeouts = new Map();

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setAlert(kind, msg) {
      const el = document.getElementById('bp-alert');
      el.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info', 'alert-warning');
      el.classList.add(`alert-${kind}`);
      el.textContent = msg;
    }

    function clearAlert() {
      const el = document.getElementById('bp-alert');
      el.classList.add('d-none');
      el.textContent = '';
    }

    function optionHtml(list, selectedId, placeholder) {
      const ph = placeholder ? `<option value="">${placeholder}</option>` : '';
      return ph + list.map(o => `<option value="${o.id}" ${String(o.id) === String(selectedId) ? 'selected' : ''}>${o.label}</option>`).join('');
    }

    async function searchLocations(query, inputEl, hiddenInput) {
      if (query.length < 1) {
        const dropdown = inputEl.parentElement.querySelector('.bp-location-dropdown');
        if (dropdown) dropdown.classList.remove('show');
        return;
      }

      try {
        const res = await fetch(`${searchLocationsUrl}?q=${encodeURIComponent(query)}`);
        const data = await res.json();
        const results = data.results || [];

        const dropdown = inputEl.parentElement.querySelector('.bp-location-dropdown');
        if (!dropdown) return;

        dropdown.innerHTML = '';
        if (results.length === 0) {
          const noResult = document.createElement('div');
          noResult.className = 'bp-location-item';
          noResult.textContent = 'Keine Ergebnisse';
          dropdown.appendChild(noResult);
        } else {
          results.forEach(loc => {
            const item = document.createElement('div');
            item.className = 'bp-location-item';
            item.textContent = loc.text;
            item.dataset.locationId = loc.id;
            item.addEventListener('click', () => {
              inputEl.value = loc.text;
              hiddenInput.value = loc.id;
              dropdown.classList.remove('show');
            });
            dropdown.appendChild(item);
          });
        }
        dropdown.classList.add('show');
      } catch (e) {
        console.error('Location search error:', e);
      }
    }

    function setupLocationInput(inputEl, hiddenInput) {
      const wrapper = inputEl.parentElement;
      const dropdown = wrapper.querySelector('.bp-location-dropdown');
      const timeoutKey = inputEl;
      
      inputEl.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        
        if (locationSearchTimeouts.has(timeoutKey)) {
          clearTimeout(locationSearchTimeouts.get(timeoutKey));
        }
        
        const timeout = setTimeout(() => {
          searchLocations(query, inputEl, hiddenInput);
        }, 300);
        locationSearchTimeouts.set(timeoutKey, timeout);
      });

      inputEl.addEventListener('focus', () => {
        if (inputEl.value.trim().length > 0) {
          searchLocations(inputEl.value.trim(), inputEl, hiddenInput);
        }
      });

      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
          if (dropdown) dropdown.classList.remove('show');
        }
      });
    }

    function rowHtml(rowId) {
      return `
        <tr data-row-id="${rowId}">
          <td class="text-center">
            <input type="checkbox" class="form-check-input bp-checkbox" disabled data-part-id="" />
          </td>
          <td>
            <select class="form-select form-select-sm bp-category">
              ${optionHtml(categories, '', 'Kategorie wählen')}
            </select>
          </td>
          <td><input class="form-control form-control-sm bp-name" type="text" placeholder="Produktname" /></td>
          <td><input class="form-control form-control-sm bp-description" type="text" placeholder="Beschreibung" /></td>
          <td><input class="form-control form-control-sm bp-ipn" type="text" placeholder="IPN" /></td>
          <td><input class="form-control form-control-sm bp-quantity" type="number" min="0" step="1" value="0" /></td>
          <td>
            <div class="bp-location-wrapper">
              <input type="text" class="bp-location-input bp-location-search" placeholder="Lagerort suchen..." autocomplete="off" />
              <input type="hidden" class="bp-location-id" value="" />
              <div class="bp-location-dropdown"></div>
            </div>
          </td>
          <td class="text-end">
            <button type="button" class="btn btn-sm btn-outline-danger bp-remove" title="Zeile entfernen">
              <i class="fas fa-times"></i>
            </button>
          </td>
        </tr>
      `;
    }

    function addRow() {
      const tbody = document.getElementById('bp-rows');
      const rowId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
      tbody.insertAdjacentHTML('beforeend', rowHtml(rowId));
      
      const newRow = tbody.querySelector(`tr[data-row-id="${rowId}"]`);
      const locationSearch = newRow.querySelector('.bp-location-search');
      const locationId = newRow.querySelector('.bp-location-id');
      if (locationSearch && locationId) {
        setupLocationInput(locationSearch, locationId);
      }
    }

    function reset() {
      clearAlert();
      document.getElementById('bp-rows').innerHTML = '';
      document.getElementById('bp-result').textContent = 'Noch keine Aktion ausgeführt.';
      document.getElementById('bp-print').disabled = true;
      document.getElementById('bp-select-all').checked = false;
      createdParts = [];
      addRow();
    }

    function collectItems() {
      const rows = Array.from(document.querySelectorAll('#bp-rows tr'));
      return rows.map(r => {
        const categoryEl = r.querySelector('.bp-category');
        const locationIdEl = r.querySelector('.bp-location-id');
        
        return {
          category_id: categoryEl ? (categoryEl.value ? Number(categoryEl.value) : null) : null,
          name: r.querySelector('.bp-name')?.value || '',
          description: r.querySelector('.bp-description')?.value || '',
          ipn: r.querySelector('.bp-ipn')?.value || '',
          quantity: r.querySelector('.bp-quantity')?.value || 0,
          location_id: locationIdEl && locationIdEl.value ? Number(locationIdEl.value) : null
        };
      });
    }

    async function submit() {
      clearAlert();
      const items = collectItems();

      if (!items.length) {
        setAlert('danger', 'Keine Zeilen vorhanden.');
        return;
      }

      setAlert('info', 'Erstelle Produkte…');

      const csrf = getCookie('csrftoken');

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(csrf ? { 'X-CSRFToken': csrf } : {})
        },
        body: JSON.stringify({ items })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        if (data.error === 'creation_disabled') {
          setAlert('danger', 'Fehler: Das Plugin ist nicht zum Erstellen aktiviert. Bitte aktivieren Sie die Einstellung "ALLOW_CREATE" in den Plugin-Einstellungen (Settings → Plugin Settings → Bulk Products).');
        } else {
          setAlert('danger', data.detail || data.error || `Fehler (${res.status})`);
        }
        return;
      }

      const results = data.results || [];
      const ok = results.filter(r => r.success).length;
      const fail = results.filter(r => !r.success).length;

      if (fail === 0) setAlert('success', `Erfolgreich erstellt: ${ok}`);
      else setAlert('danger', `Erstellt: ${ok}, Fehler: ${fail} (Details unten)`);

      createdParts = results.filter(r => r.success && r.part).map(r => r.part);

      const out = [];
      out.push(`<div class="mb-2"><strong>Erstellt:</strong> ${ok} &nbsp;&nbsp; <strong>Fehler:</strong> ${fail}</div>`);
      out.push('<ul class="mb-0">');
      for (const r of results) {
        if (r.success) {
          const p = r.part || {};
          const url = p.url || '#';
          const rows = Array.from(document.querySelectorAll('#bp-rows tr'));
          if (rows[r.index]) {
            const checkbox = rows[r.index].querySelector('.bp-checkbox');
            if (checkbox) {
              checkbox.disabled = false;
              checkbox.dataset.partId = p.id;
              checkbox.checked = true;
            }
          }
          out.push(`<li>OK: <a href="${url}" target="_blank">${p.name}</a> (ID ${p.id}${p.ipn ? `, IPN ${p.ipn}` : ''})</li>`);
        } else {
          out.push(`<li>FEHLER: Zeile ${Number(r.index) + 1}: ${r.error}${r.detail ? ` (${r.detail})` : ''}</li>`);
        }
      }
      out.push('</ul>');

      document.getElementById('bp-result').innerHTML = out.join('');
      
      if (createdParts.length > 0) {
        document.getElementById('bp-print').disabled = false;
        updateSelectAllState();
      }
    }

    function updateSelectAllState() {
      const selectAll = document.getElementById('bp-select-all');
      const checkboxes = Array.from(document.querySelectorAll('.bp-checkbox:not([disabled])'));
      const checked = checkboxes.filter(cb => cb.checked);
      
      if (checkboxes.length === 0) {
        selectAll.disabled = true;
        selectAll.checked = false;
      } else {
        selectAll.disabled = false;
        selectAll.checked = checked.length === checkboxes.length && checkboxes.length > 0;
        selectAll.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
      }
    }

    async function printLabels() {
      const selectedCheckboxes = Array.from(document.querySelectorAll('.bp-checkbox:checked:not([disabled])'));
      const selectedPartIds = selectedCheckboxes
        .map(cb => cb.dataset.partId)
        .filter(id => id);

      if (selectedPartIds.length === 0) {
        setAlert('warning', 'Bitte wählen Sie mindestens ein Produkt aus.');
        return;
      }

      if (typeof inventreeLoad !== 'undefined' && inventreeLoad.api) {
        const items = selectedPartIds.map(id => `part:${id}`);
        try {
          const response = await inventreeLoad.api.post('/api/label/print/', {
            items: items
          });
          
          if (response.data && response.data.url) {
            window.open(response.data.url, '_blank');
          } else if (response.data && response.data.redirect) {
            window.location.href = response.data.redirect;
          } else {
            if (typeof showPrintDialog === 'function') {
              showPrintDialog('part', selectedPartIds);
            } else {
              setAlert('warning', 'Label-Druck nicht verfügbar.');
            }
          }
        } catch (error) {
          console.error('Label print error:', error);
          if (typeof showPrintDialog === 'function') {
            showPrintDialog('part', selectedPartIds);
          } else {
            setAlert('danger', 'Fehler beim Drucken der Labels.');
          }
        }
      } else if (typeof showPrintDialog === 'function') {
        showPrintDialog('part', selectedPartIds);
      } else {
        const items = selectedPartIds.map(id => `part:${id}`).join(',');
        const url = `/api/label/print/?items=${items}`;
        window.open(url, '_blank');
      }
    }

    function bindEvents() {
      document.getElementById('bp-add-row').addEventListener('click', addRow);
      document.getElementById('bp-reset').addEventListener('click', reset);
      document.getElementById('bp-submit').addEventListener('click', () => submit().catch(e => {
        setAlert('danger', e?.message || 'Unbekannter Fehler');
      }));
      document.getElementById('bp-print').addEventListener('click', printLabels);

      document.getElementById('bp-select-all').addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.bp-checkbox:not([disabled])');
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
        });
      });

      document.getElementById('bp-rows').addEventListener('change', (e) => {
        if (e.target.classList.contains('bp-checkbox')) {
          updateSelectAllState();
        }
      });

      document.getElementById('bp-rows').addEventListener('click', (e) => {
        if (e.target.closest('.bp-remove') || e.target.closest('.fa-times')) {
          e.preventDefault();
          e.stopPropagation();
          const row = e.target.closest('tr');
          if (row) {
            row.remove();
            updateSelectAllState();
          }
        }
      });
    }

    return { reset, bindEvents };
  })();

  document.addEventListener('DOMContentLoaded', function() {
    BP.bindEvents();
    BP.reset();
  });
</script>
{% endblock content %}
