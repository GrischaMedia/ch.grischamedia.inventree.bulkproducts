<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ plugin_title }} - InvenTree</title>
  <style>
body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: #f5f5f5;
  color: #212529;
}

.page {
  display: flex;
  flex-direction: column;
}

.topbar {
  background-color: #2c3e50;
  color: white;
  padding: 1rem 2rem;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.version-badge {
  display: inline-block;
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  font-weight: 500;
  border: 1px solid rgba(255, 255, 255, 0.3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.container {
  max-width: 1600px;
  margin: 2rem auto;
  padding: 0 1rem;
  width: 100%;
}

.card {
  background: white;
  border-radius: 0.5rem;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  margin-bottom: 2rem;
}

.card-header {
  padding: 1.5rem;
  border-bottom: 1px solid #dee2e6;
  background-color: #f8f9fa;
  border-radius: 0.5rem 0.5rem 0 0;
}

.card-title {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 600;
  color: #212529;
}

.card-body {
  padding: 1.5rem;
  overflow: visible;
}

.table-responsive {
  overflow-x: auto;
  overflow-y: visible;
  max-height: none;
  position: relative;
}

@media (max-width: 1600px) {
  .table-responsive {
    overflow-x: auto;
    overflow-y: visible;
  }
}

.table {
  width: 100%;
  margin-bottom: 1rem;
  color: #212529;
  border-collapse: collapse;
}

.table thead th {
  vertical-align: bottom;
  border-bottom: 2px solid #dee2e6;
  padding: 0.75rem;
  font-weight: 600;
  background-color: #f8f9fa;
}

.table tbody td {
  padding: 0.75rem;
  vertical-align: middle;
  border-top: 1px solid #dee2e6;
}

.table-hover tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.02);
}

.table-light {
  background-color: #f8f9fa;
}

.btn {
  display: inline-block;
  font-weight: 500;
  text-align: center;
  vertical-align: middle;
  cursor: pointer;
  user-select: none;
  border: 1px solid transparent;
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  line-height: 1.5;
  border-radius: 0.375rem;
  transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  text-decoration: none;
}

.btn-primary {
  color: #fff;
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.btn-primary:hover {
  color: #fff;
  background-color: #0b5ed7;
  border-color: #0a58ca;
}

.btn-success {
  color: #fff;
  background-color: #198754;
  border-color: #198754;
}

.btn-success:hover {
  color: #fff;
  background-color: #157347;
  border-color: #146c43;
}

.btn-outline-secondary {
  color: #6c757d;
  border-color: #6c757d;
  background-color: transparent;
}

.btn-outline-secondary:hover {
  color: #fff;
  background-color: #6c757d;
  border-color: #6c757d;
}

.btn-outline-danger {
  color: #dc3545;
  border-color: #dc3545;
  background-color: transparent;
}

.btn-outline-danger:hover {
  color: #fff;
  background-color: #dc3545;
  border-color: #dc3545;
}

.btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.btn-lg {
  padding: 0.75rem 1.5rem;
  font-size: 1.1rem;
}

.form-control {
  display: block;
  width: 100%;
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
  font-weight: 400;
  line-height: 1.5;
  color: #212529;
  background-color: #fff;
  background-image: none;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
  color: #212529;
  background-color: #fff;
  border-color: #86b7fe;
  outline: 0;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-control-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.form-select {
  display: block;
  width: 100%;
  padding: 0.375rem 2.25rem 0.375rem 0.75rem;
  font-size: 0.875rem;
  font-weight: 400;
  line-height: 1.5;
  color: #212529;
  background-color: #fff;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 16px 12px;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-select:focus {
  border-color: #86b7fe;
  outline: 0;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-select-sm {
  padding: 0.25rem 2rem 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.alert {
  position: relative;
  padding: 0.75rem 1.25rem;
  margin-bottom: 1rem;
  border: 1px solid transparent;
  border-radius: 0.25rem;
}

.alert-success {
  color: #0f5132;
  background-color: #d1e7dd;
  border-color: #badbcc;
}

.alert-danger {
  color: #842029;
  background-color: #f8d7da;
  border-color: #f5c2c7;
}

.alert-info {
  color: #055160;
  background-color: #cff4fc;
  border-color: #b6effb;
}

.alert-warning {
  color: #664d03;
  background-color: #fff3cd;
  border-color: #ffecb5;
}

.d-none {
  display: none !important;
}

.d-flex {
  display: flex !important;
}

.gap-2 {
  gap: 0.5rem;
}

.justify-content-end {
  justify-content: flex-end;
}

.mt-3 {
  margin-top: 1rem;
}

.mb-3 {
  margin-bottom: 1rem;
}

.mb-4 {
  margin-bottom: 1.5rem;
}

.my-4 {
  margin-top: 1.5rem;
  margin-bottom: 1.5rem;
}

.text-center {
  text-align: center;
}

.text-end {
  text-align: right;
}

.text-muted {
  color: #6c757d;
}

.text-danger {
  color: #dc3545;
}

.small {
  font-size: 0.875em;
}

hr {
  margin: 1.5rem 0;
  color: inherit;
  background-color: currentColor;
  border: 0;
  opacity: 0.25;
  height: 1px;
}

h5 {
  margin-top: 0;
  margin-bottom: 0.5rem;
  font-weight: 500;
  line-height: 1.2;
  font-size: 1.25rem;
}

.list-group {
  display: flex;
  flex-direction: column;
  padding-left: 0;
  margin-bottom: 0;
}

.list-group-item {
  position: relative;
  display: block;
  padding: 0.75rem 1.25rem;
  margin-bottom: 0.5rem;
  color: #212529;
  text-decoration: none;
  background-color: #fff;
  border: 1px solid rgba(0, 0, 0, 0.125);
  border-radius: 0.25rem;
}

.list-group-item:hover {
  background-color: #f8f9fa;
}

.list-group-item a {
  color: #0d6efd;
  text-decoration: none;
  font-weight: 500;
}

.list-group-item a:hover {
  text-decoration: underline;
}

.bp-location-wrapper {
  position: relative;
  width: 100%;
}

.bp-location-input {
  width: 100%;
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
  line-height: 1.5;
  color: #212529;
  background-color: #fff;
  border: 1px solid #ced4da;
  border-radius: 0.25rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.bp-location-input:focus {
  color: #212529;
  background-color: #fff;
  border-color: #86b7fe;
  outline: 0;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.bp-location-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ced4da;
  border-top: none;
  border-radius: 0 0 0.25rem 0.25rem;
  max-height: 150px;
  overflow-y: auto;
  z-index: 1001;
  display: none;
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  margin-top: -1px;
}

.bp-location-dropdown.show {
  display: block;
}

.bp-location-item {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  border-bottom: 1px solid #f8f9fa;
}

.bp-location-item:last-child {
  border-bottom: none;
}

.bp-location-item:hover {
  background-color: #f8f9fa;
}

.bp-location-item.selected {
  background-color: #0d6efd;
  color: white;
}

.bp-remove {
  margin: 0;
  padding: 0.25rem 0.5rem;
  display: inline-block;
}

.io-footer {
  margin-top: 20px;
  text-align: center;
  font-size: 0.85em;
  color: #666;
}

.io-footer a {
  color: #0d6efd;
  text-decoration: none;
}

.io-footer a:hover {
  text-decoration: underline;
}
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <span>InvenTree - {{ plugin_title }}</span>
      {% if plugin_version %}
      <span class="version-badge">v{{ plugin_version }}</span>
      {% endif %}
    </div>

    <div class="container">
      <div class="card">
        <div class="card-header">
          <h1 class="card-title">{{ plugin_title }}</h1>
        </div>

        <div class="card-body">
          <form class="d-none">{% csrf_token %}</form>

          <div id="bp-alert" class="alert d-none" role="alert"></div>

          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle" style="margin-bottom: 0;">
              <thead class="table-light">
                <tr>
                  <th style="width: 40px;" class="text-center"></th>
                  <th style="min-width: 220px;">Kategorie *</th>
                  <th style="min-width: 220px;">Name *</th>
                  <th style="min-width: 260px;">Beschreibung</th>
                  <th style="min-width: 180px;">IPN</th>
                  <th style="width: 140px;">Anzahl</th>
                  <th style="min-width: 260px;">Lagerort</th>
                  <th style="width: 90px;" class="text-end">Aktion</th>
                </tr>
              </thead>
              <tbody id="bp-rows"></tbody>
            </table>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="button" class="btn btn-primary" id="bp-add-row">
              + Hinzufügen
            </button>
            <button type="button" class="btn btn-outline-secondary" id="bp-reset">
              ↻ Zurücksetzen
            </button>
          </div>

          <hr class="my-4" />

          <div class="d-flex justify-content-end mb-3">
            <button type="button" class="btn btn-success btn-lg" id="bp-submit">
              ✓ Teile Erstellen / Einbuchen
            </button>
          </div>

          <h5 class="mb-3">Ergebnis</h5>
          <div id="bp-result" class="small text-muted mb-3">Noch keine Aktion ausgeführt.</div>

          <div id="bp-created-parts" class="mt-3 d-none">
            <h5 class="mb-3">Erstellte Produkte</h5>
            <div class="list-group" id="bp-parts-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <footer style="text-align:center; font-size:0.85em; color:#666; padding:1rem 0;">
      © 2025 GrischaMedia – <a href="https://github.com/GrischaMedia/ch.grischamedia.inventree.bulkproducts" target="_blank" style="color:#0d6efd; text-decoration:none;">GitHub Repository</a>
    </footer>
  </div>

  <script>
    (function() {
      const BP = {
        csrf: '{{ csrf_token }}',
        categories: [
          {% for c in categories %}
            { id: {{ c.id }}, label: "{{ c.pathstring|default:c.name|escapejs }}" },
          {% endfor %}
        ],
        defaultLocationId: {{ default_location_id|default:0 }},
        apiUrl: "{% url 'plugin:bulk-products:api-bulk-create' %}",
        searchLocationsUrl: "{% url 'plugin:bulk-products:api-search-locations' %}",
        createdParts: [],
        locationSearchTimeouts: new Map()
      };
      
      let createdParts = [];
      let locationSearchTimeouts = new Map();

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return BP.csrf || null;
      }

      function setAlert(kind, msg) {
        const el = document.getElementById('bp-alert');
        if (!el) return;
        el.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info', 'alert-warning');
        el.classList.add(`alert-${kind}`);
        el.textContent = msg;
      }

      function clearAlert() {
        const el = document.getElementById('bp-alert');
        if (!el) return;
        el.classList.add('d-none');
        el.textContent = '';
      }

      function optionHtml(list, selectedId, placeholder) {
        const ph = placeholder ? `<option value="">${placeholder}</option>` : '';
        return ph + list.map(o => `<option value="${o.id}" ${String(o.id) === String(selectedId) ? 'selected' : ''}>${o.label}</option>`).join('');
      }

      async function searchLocations(query, inputEl, hiddenInput) {
        if (query.length < 1) {
          const dropdown = inputEl.parentElement.querySelector('.bp-location-dropdown');
          if (dropdown) dropdown.classList.remove('show');
          return;
        }

        try {
          const res = await fetch(`${BP.searchLocationsUrl}?q=${encodeURIComponent(query)}`);
          const data = await res.json();
          const results = data.results || [];

          const dropdown = inputEl.parentElement.querySelector('.bp-location-dropdown');
          if (!dropdown) return;

          dropdown.innerHTML = '';
          if (results.length === 0) {
            const noResult = document.createElement('div');
            noResult.className = 'bp-location-item';
            noResult.textContent = 'Keine Ergebnisse';
            dropdown.appendChild(noResult);
          } else {
            results.forEach(loc => {
              const item = document.createElement('div');
              item.className = 'bp-location-item';
              item.textContent = loc.text;
              item.dataset.locationId = loc.id;
              item.addEventListener('click', () => {
                inputEl.value = loc.text;
                hiddenInput.value = loc.id;
                dropdown.classList.remove('show');
              });
              dropdown.appendChild(item);
            });
          }
          dropdown.classList.add('show');
        } catch (e) {
          console.error('Location search error:', e);
        }
      }

      async function findLocationByText(text) {
        if (!text || text.trim().length === 0) return null;
        
        const searchText = text.trim();
        
        try {
          // Versuche zuerst mit dem vollständigen Text
          let res = await fetch(`${BP.searchLocationsUrl}?q=${encodeURIComponent(searchText)}`);
          let data = await res.json();
          let results = data.results || [];
          
          // Suche nach exakter Übereinstimmung (case-sensitive)
          let exactMatch = results.find(loc => loc.text === searchText);
          if (exactMatch) {
            return exactMatch.id;
          }
          
          // Suche nach exakter Übereinstimmung (case-insensitive)
          exactMatch = results.find(loc => loc.text.toLowerCase() === searchText.toLowerCase());
          if (exactMatch) {
            return exactMatch.id;
          }
          
          // Wenn nur ein Ergebnis, nimm das
          if (results.length === 1) {
            return results[0].id;
          }
          
          // Wenn mehrere Ergebnisse, suche nach exakter Übereinstimmung
          exactMatch = results.find(loc => loc.text === searchText || loc.text.toLowerCase() === searchText.toLowerCase());
          if (exactMatch) {
            return exactMatch.id;
          }
          
          // Versuche mit verschiedenen Teilen des Pfads
          const parts = searchText.split('/').filter(p => p.trim().length > 0);
          if (parts.length > 0) {
            // Versuche mit dem letzten Teil (z.B. "Fach 13")
            const lastPart = parts[parts.length - 1].trim();
            res = await fetch(`${BP.searchLocationsUrl}?q=${encodeURIComponent(lastPart)}`);
            data = await res.json();
            results = data.results || [];
            
            // Suche nach Übereinstimmung am Ende
            const endMatch = results.find(loc => {
              const locText = loc.text.toLowerCase();
              const searchLower = searchText.toLowerCase();
              return locText === searchLower || locText.endsWith('/' + searchLower) || locText.endsWith(searchLower);
            });
            if (endMatch) {
              return endMatch.id;
            }
            
            // Suche nach Übereinstimmung, die den vollständigen Pfad enthält
            const fullPathMatch = results.find(loc => {
              const locText = loc.text.toLowerCase();
              return locText.includes(searchLower) || searchLower.includes(locText);
            });
            if (fullPathMatch) {
              return fullPathMatch.id;
            }
          }
          
          return null;
        } catch (e) {
          console.error('Location search error:', e);
          return null;
        }
      }

      function setupLocationInput(inputEl, hiddenInput) {
        const wrapper = inputEl.parentElement;
        const dropdown = wrapper.querySelector('.bp-location-dropdown');
        const timeoutKey = inputEl;
        
        inputEl.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          
          if (locationSearchTimeouts.has(timeoutKey)) {
            clearTimeout(locationSearchTimeouts.get(timeoutKey));
          }
          
          const timeout = setTimeout(() => {
            searchLocations(query, inputEl, hiddenInput);
          }, 300);
          locationSearchTimeouts.set(timeoutKey, timeout);
        });

        inputEl.addEventListener('focus', () => {
          if (inputEl.value.trim().length > 0) {
            searchLocations(inputEl.value.trim(), inputEl, hiddenInput);
          }
        });

        // Beim Verlassen des Feldes versuchen, die location_id zu finden
        inputEl.addEventListener('blur', async () => {
          const text = inputEl.value.trim();
          if (text && !hiddenInput.value) {
            const locationId = await findLocationByText(text);
            if (locationId) {
              hiddenInput.value = locationId;
            }
          }
        });

        document.addEventListener('click', (e) => {
          if (!wrapper.contains(e.target)) {
            if (dropdown) dropdown.classList.remove('show');
          }
        });
      }

      function rowHtml(rowId) {
        return `
          <tr data-row-id="${rowId}">
            <td class="text-center"></td>
            <td>
              <select class="form-select form-select-sm bp-category">
                ${optionHtml(BP.categories, '', 'Kategorie wählen')}
              </select>
            </td>
            <td><input class="form-control form-control-sm bp-name" type="text" placeholder="Produktname" /></td>
            <td><input class="form-control form-control-sm bp-description" type="text" placeholder="Beschreibung" /></td>
            <td><input class="form-control form-control-sm bp-ipn" type="text" placeholder="IPN" /></td>
            <td><input class="form-control form-control-sm bp-quantity" type="number" min="0" step="1" value="0" /></td>
            <td>
              <div class="bp-location-wrapper">
                <input type="text" class="bp-location-input bp-location-search" placeholder="Lagerort suchen..." autocomplete="off" />
                <input type="hidden" class="bp-location-id" value="" />
                <div class="bp-location-dropdown"></div>
              </div>
            </td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-danger bp-remove" title="Zeile entfernen">
                ✕
              </button>
            </td>
          </tr>
        `;
      }

      function addRow() {
        const tbody = document.getElementById('bp-rows');
        if (!tbody) return;
        const rowId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
        tbody.insertAdjacentHTML('beforeend', rowHtml(rowId));
        
        const newRow = tbody.querySelector(`tr[data-row-id="${rowId}"]`);
        if (!newRow) return;
        const locationSearch = newRow.querySelector('.bp-location-search');
        const locationId = newRow.querySelector('.bp-location-id');
        if (locationSearch && locationId) {
          setupLocationInput(locationSearch, locationId);
        }
      }

      function reset() {
        clearAlert();
        const tbody = document.getElementById('bp-rows');
        if (tbody) tbody.innerHTML = '';
        const resultEl = document.getElementById('bp-result');
        if (resultEl) resultEl.textContent = 'Noch keine Aktion ausgeführt.';
        const partsContainer = document.getElementById('bp-created-parts');
        if (partsContainer) partsContainer.classList.add('d-none');
        const partsList = document.getElementById('bp-parts-list');
        if (partsList) partsList.innerHTML = '';
        createdParts = [];
        addRow();
      }

      async function collectItems() {
        const rows = Array.from(document.querySelectorAll('#bp-rows tr'));
        const items = [];
        
        for (const r of rows) {
          const categoryEl = r.querySelector('.bp-category');
          const locationIdEl = r.querySelector('.bp-location-id');
          const locationInput = r.querySelector('.bp-location-search');
          
          let locationId = locationIdEl && locationIdEl.value ? Number(locationIdEl.value) : null;
          
          // Wenn keine location_id, aber Text eingegeben wurde, versuche zu finden
          if (!locationId && locationInput && locationInput.value.trim()) {
            locationId = await findLocationByText(locationInput.value.trim());
            if (locationId && locationIdEl) {
              locationIdEl.value = locationId;
            }
          }
          
          items.push({
            category_id: categoryEl ? (categoryEl.value ? Number(categoryEl.value) : null) : null,
            name: r.querySelector('.bp-name')?.value || '',
            description: r.querySelector('.bp-description')?.value || '',
            ipn: r.querySelector('.bp-ipn')?.value || '',
            quantity: r.querySelector('.bp-quantity')?.value || 0,
            location_id: locationId
          });
        }
        
        return items;
      }

      function renderCreatedParts() {
        const container = document.getElementById('bp-parts-list');
        const partsContainer = document.getElementById('bp-created-parts');
        
        if (!container || !partsContainer) return;
        
        if (createdParts.length === 0) {
          partsContainer.classList.add('d-none');
          return;
        }

        partsContainer.classList.remove('d-none');
        container.innerHTML = '';

        createdParts.forEach(part => {
          const item = document.createElement('div');
          item.className = 'list-group-item';
          item.style.display = 'flex';
          item.style.justifyContent = 'space-between';
          item.style.alignItems = 'center';
          
          const link = document.createElement('a');
          link.href = part.url || '#';
          link.target = '_blank';
          link.textContent = part.name;
          
          const info = document.createElement('span');
          info.className = 'text-muted small';
          let infoText = `ID: ${part.id}`;
          if (part.ipn) {
            infoText += ` | IPN: ${part.ipn}`;
          }
          info.textContent = infoText;

          item.appendChild(link);
          item.appendChild(info);
          container.appendChild(item);
        });
      }

      async function submit() {
        clearAlert();
        const items = await collectItems();

        if (!items.length) {
          setAlert('danger', 'Keine Zeilen vorhanden.');
          return;
        }

        setAlert('info', 'Erstelle Produkte…');

        const csrf = getCookie('csrftoken');

        try {
          const res = await fetch(BP.apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(csrf ? { 'X-CSRFToken': csrf } : {})
            },
            body: JSON.stringify({ items })
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok) {
            if (data.error === 'creation_disabled') {
              setAlert('danger', 'Fehler: Das Plugin ist nicht zum Erstellen aktiviert. Bitte aktivieren Sie die Einstellung "ALLOW_CREATE" in den Plugin-Einstellungen (Settings → Plugin Settings → Bulk Products).');
            } else {
              setAlert('danger', data.detail || data.error || `Fehler (${res.status})`);
            }
            return;
          }

          const results = data.results || [];
          const ok = results.filter(r => r.success).length;
          const fail = results.filter(r => !r.success).length;

          if (fail === 0) setAlert('success', `Erfolgreich erstellt: ${ok}`);
          else setAlert('danger', `Erstellt: ${ok}, Fehler: ${fail} (Details unten)`);

          createdParts = results.filter(r => r.success && r.part).map(r => r.part);

          const out = [];
          out.push(`<div class="mb-2"><strong>Erstellt:</strong> ${ok} &nbsp;&nbsp; <strong>Fehler:</strong> ${fail}</div>`);
          if (fail > 0) {
            out.push('<ul class="mb-0">');
            for (const r of results) {
              if (!r.success) {
                out.push(`<li class="text-danger">FEHLER: Zeile ${Number(r.index) + 1}: ${r.error}${r.detail ? ` (${r.detail})` : ''}</li>`);
              }
            }
            out.push('</ul>');
          }

          const resultEl = document.getElementById('bp-result');
          if (resultEl) resultEl.innerHTML = out.join('');
          
          renderCreatedParts();
        } catch (e) {
          setAlert('danger', 'Fehler beim Erstellen: ' + (e.message || 'Unbekannter Fehler'));
        }
      }

      function bindEvents() {
        const addRowBtn = document.getElementById('bp-add-row');
        if (addRowBtn) {
          addRowBtn.addEventListener('click', addRow);
        }

        const resetBtn = document.getElementById('bp-reset');
        if (resetBtn) {
          resetBtn.addEventListener('click', reset);
        }

        const submitBtn = document.getElementById('bp-submit');
        if (submitBtn) {
          submitBtn.addEventListener('click', () => submit().catch(e => {
            setAlert('danger', e?.message || 'Unbekannter Fehler');
          }));
        }

        const tbody = document.getElementById('bp-rows');
        if (tbody) {
          tbody.addEventListener('click', (e) => {
            if (e.target.closest('.bp-remove')) {
              e.preventDefault();
              e.stopPropagation();
              const row = e.target.closest('tr');
              if (row) {
                row.remove();
              }
            }
          });
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          bindEvents();
          reset();
        });
      } else {
        bindEvents();
        reset();
      }
    })();
  </script>
</body>
</html>
