{% extends "base.html" %}
{% load i18n %}

{% block page_title %}
{{ plugin_title }}
{% endblock page_title %}

{% block breadcrumbs %}
{% endblock breadcrumbs %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h3 class="card-title mb-3">{{ plugin_title }}</h3>

          <form class="d-none">{% csrf_token %}</form>

          <div id="bp-alert" class="alert d-none" role="alert"></div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th style="width: 40px;"></th>
                  <th style="min-width: 220px;">Kategorie *</th>
                  <th style="min-width: 220px;">Name *</th>
                  <th style="min-width: 260px;">Beschreibung</th>
                  <th style="min-width: 180px;">IPN</th>
                  <th style="width: 140px;">Anzahl</th>
                  <th style="min-width: 260px;">Lagerort</th>
                  <th style="width: 90px;">Aktion</th>
                </tr>
              </thead>
              <tbody id="bp-rows"></tbody>
            </table>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="button" class="btn btn-primary" id="bp-add-row">+ Hinzufügen</button>
            <button type="button" class="btn btn-success" id="bp-submit">Erstellen</button>
            <button type="button" class="btn btn-outline-secondary" id="bp-reset">Zurücksetzen</button>
          </div>

          <hr class="my-4" />

          <h5>Ergebnis</h5>
          <div id="bp-result" class="small text-muted">Noch keine Aktion ausgeführt.</div>

          <div class="mt-3">
            <button type="button" class="btn btn-outline-primary" id="bp-print" disabled>
              Labels drucken
            </button>
            <div class="form-text">
              Wählen Sie die erstellten Produkte per Checkbox aus und klicken Sie auf "Labels drucken", um den InvenTree Label-Dialog zu öffnen.
            </div>
          </div>
        </div>
      </div>

      <div class="text-center small text-muted my-4">
        © 2025 GrischaMedia.ch - <a href="https://github.com/GrischaMedia/ch.grischamedia.inventree.bulkproducts" target="_blank">GitHub Repository</a>
      </div>
    </div>
  </div>
</div>

<script>
  const BP = (() => {
    const categories = [
      {% for c in categories %}
        { id: {{ c.id }}, label: "{{ c.pathstring|default:c.name|escapejs }}" },
      {% endfor %}
    ];

    const defaultLocationId = {{ default_location_id|default:0 }};
    const apiUrl = "{% url 'plugin:bulk-products:api-bulk-create' %}";
    const searchLocationsUrl = "{% url 'plugin:bulk-products:api-search-locations' %}";
    let createdParts = [];

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setAlert(kind, msg) {
      const el = document.getElementById('bp-alert');
      el.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
      el.classList.add(`alert-${kind}`);
      el.textContent = msg;
    }

    function clearAlert() {
      const el = document.getElementById('bp-alert');
      el.classList.add('d-none');
      el.textContent = '';
    }

    function optionHtml(list, selectedId, placeholder) {
      const ph = placeholder ? `<option value="">${placeholder}</option>` : '';
      return ph + list.map(o => `<option value="${o.id}" ${String(o.id) === String(selectedId) ? 'selected' : ''}>${o.label}</option>`).join('');
    }

    function initLocationSelect(selectEl) {
      if (typeof $.fn.select2 === 'undefined') {
        console.warn('Select2 not available, falling back to regular select');
        return;
      }

      $(selectEl).select2({
        ajax: {
          url: searchLocationsUrl,
          dataType: 'json',
          delay: 250,
          data: function (params) {
            return {
              q: params.term
            };
          },
          processResults: function (data) {
            return {
              results: data.results || []
            };
          },
          cache: true
        },
        placeholder: 'Lagerort suchen...',
        allowClear: true,
        minimumInputLength: 1,
        width: '100%'
      });
    }

    function rowHtml(rowId) {
      return `
        <tr data-row-id="${rowId}">
          <td class="text-center">
            <input type="checkbox" class="form-check-input bp-checkbox" disabled />
          </td>
          <td>
            <select class="form-select form-select-sm bp-category">
              ${optionHtml(categories, '', 'Kategorie wählen')}
            </select>
          </td>
          <td><input class="form-control form-control-sm bp-name" type="text" placeholder="Produktname" /></td>
          <td><input class="form-control form-control-sm bp-description" type="text" placeholder="Beschreibung" /></td>
          <td><input class="form-control form-control-sm bp-ipn" type="text" placeholder="IPN" /></td>
          <td><input class="form-control form-control-sm bp-quantity" type="number" min="0" step="1" value="0" /></td>
          <td>
            <select class="form-select form-select-sm bp-location" style="width: 100%;">
              <option value="">Nicht einbuchen</option>
            </select>
          </td>
          <td class="text-end">
            <button type="button" class="btn btn-sm btn-outline-danger bp-remove">X</button>
          </td>
        </tr>
      `;
    }

    function addRow() {
      const tbody = document.getElementById('bp-rows');
      const rowId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
      tbody.insertAdjacentHTML('beforeend', rowHtml(rowId));
      
      const newRow = tbody.querySelector(`tr[data-row-id="${rowId}"]`);
      const locationSelect = newRow.querySelector('.bp-location');
      if (locationSelect) {
        initLocationSelect(locationSelect);
      }
    }

    function reset() {
      clearAlert();
      document.getElementById('bp-rows').innerHTML = '';
      document.getElementById('bp-result').textContent = 'Noch keine Aktion ausgeführt.';
      document.getElementById('bp-print').disabled = true;
      createdParts = [];
      addRow();
    }

    function collectItems() {
      const rows = Array.from(document.querySelectorAll('#bp-rows tr'));
      return rows.map(r => {
        const categoryEl = r.querySelector('.bp-category');
        const locationEl = r.querySelector('.bp-location');
        
        let locationId = null;
        if (locationEl && typeof $(locationEl).select2 !== 'undefined') {
          locationId = $(locationEl).val();
        } else {
          locationId = locationEl ? locationEl.value : null;
        }

        return {
          category_id: categoryEl ? (categoryEl.value ? Number(categoryEl.value) : null) : null,
          name: r.querySelector('.bp-name')?.value || '',
          description: r.querySelector('.bp-description')?.value || '',
          ipn: r.querySelector('.bp-ipn')?.value || '',
          quantity: r.querySelector('.bp-quantity')?.value || 0,
          location_id: locationId ? Number(locationId) : null
        };
      });
    }

    async function submit() {
      clearAlert();
      const items = collectItems();

      if (!items.length) {
        setAlert('danger', 'Keine Zeilen vorhanden.');
        return;
      }

      setAlert('info', 'Erstelle Produkte…');

      const csrf = getCookie('csrftoken');

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(csrf ? { 'X-CSRFToken': csrf } : {})
        },
        body: JSON.stringify({ items })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        setAlert('danger', data.detail || data.error || `Fehler (${res.status})`);
        return;
      }

      const results = data.results || [];
      const ok = results.filter(r => r.success).length;
      const fail = results.filter(r => !r.success).length;

      if (fail === 0) setAlert('success', `Erfolgreich erstellt: ${ok}`);
      else setAlert('danger', `Erstellt: ${ok}, Fehler: ${fail} (Details unten)`);

      createdParts = results.filter(r => r.success && r.part).map(r => r.part);

      const out = [];
      out.push(`<div class="mb-2"><strong>Erstellt:</strong> ${ok} &nbsp;&nbsp; <strong>Fehler:</strong> ${fail}</div>`);
      out.push('<ul class="mb-0">');
      for (const r of results) {
        if (r.success) {
          const p = r.part || {};
          const url = p.url || '#';
          const rows = Array.from(document.querySelectorAll('#bp-rows tr'));
          if (rows[r.index]) {
            const checkbox = rows[r.index].querySelector('.bp-checkbox');
            if (checkbox) {
              checkbox.disabled = false;
              checkbox.dataset.partId = p.id;
              checkbox.checked = true;
            }
          }
          out.push(`<li>OK: <a href="${url}">${p.name}</a> (ID ${p.id}${p.ipn ? `, IPN ${p.ipn}` : ''})</li>`);
        } else {
          out.push(`<li>FEHLER: Zeile ${Number(r.index) + 1}: ${r.error}${r.detail ? ` (${r.detail})` : ''}</li>`);
        }
      }
      out.push('</ul>');

      document.getElementById('bp-result').innerHTML = out.join('');
      
      if (createdParts.length > 0) {
        document.getElementById('bp-print').disabled = false;
        const checkboxes = document.querySelectorAll('.bp-checkbox');
        checkboxes.forEach(cb => {
          if (createdParts.some(p => p.id === Number(cb.dataset.partId))) {
            cb.disabled = false;
          }
        });
      }
    }

    function printLabels() {
      const selectedCheckboxes = Array.from(document.querySelectorAll('.bp-checkbox:checked'));
      const selectedPartIds = selectedCheckboxes
        .map(cb => cb.dataset.partId)
        .filter(id => id);

      if (selectedPartIds.length === 0) {
        setAlert('warning', 'Bitte wählen Sie mindestens ein Produkt aus.');
        return;
      }

      const url = `/api/part/label/?parts=${selectedPartIds.join(',')}`;
      
      if (typeof window.showPrintDialog === 'function') {
        window.showPrintDialog('part', selectedPartIds);
      } else if (typeof window.inventreePrintLabels === 'function') {
        window.inventreePrintLabels(selectedPartIds);
      } else {
        window.open(url, '_blank');
      }
    }

    function bindEvents() {
      document.getElementById('bp-add-row').addEventListener('click', addRow);
      document.getElementById('bp-reset').addEventListener('click', reset);
      document.getElementById('bp-submit').addEventListener('click', () => submit().catch(e => {
        setAlert('danger', e?.message || 'Unbekannter Fehler');
      }));
      document.getElementById('bp-print').addEventListener('click', printLabels);

      document.getElementById('bp-rows').addEventListener('click', (e) => {
        const btn = e.target.closest('.bp-remove');
        if (!btn) return;
        btn.closest('tr')?.remove();
      });
    }

    return { reset, bindEvents };
  })();

  document.addEventListener('DOMContentLoaded', function() {
    if (typeof $ === 'undefined') {
      console.warn('jQuery not available, Select2 will not work');
    }
    BP.bindEvents();
    BP.reset();
  });
</script>
{% endblock content %}
